global
    log stdout format raw local0 info

defaults
    mode http
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    # This line is the magic fix: it tells HAProxy not to crash if DNS fails at start
    default-server init-addr last,libc,none

frontend http-in
    bind *:80
    
    acl is_matrix path_beg /_matrix
    acl is_matrix path_beg /_synapse
    use_backend synapse_backend if is_matrix

    acl is_auth path_beg /auth
    acl is_auth path_beg /.well-known/openid-configuration
    use_backend mas_backend if is_auth

    default_backend element_backend

backend synapse_backend
    server synapse synapse.railway.internal:8008 check

backend mas_backend
    server mas matrix-authentication-service.railway.internal:8080 check

backend element_backend
    server element element-web.railway.internal:80 check
